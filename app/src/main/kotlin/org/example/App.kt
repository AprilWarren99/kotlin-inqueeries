/*
 * This source file was generated by the Gradle 'init' task
 */
package org.example

import io.ktor.http.HttpStatusCode
import io.ktor.server.application.install
import org.example.dbHandler.Handler

import io.ktor.server.netty.*
import io.ktor.server.routing.*
import io.ktor.server.engine.*
import io.ktor.server.response.*
import io.ktor.server.html.respondHtml
import io.ktor.server.htmx.hx
import io.ktor.server.http.content.staticResources
import io.ktor.server.plugins.statuspages.StatusPages
import io.ktor.server.request.path
import io.ktor.utils.io.ExperimentalKtorApi
import kotlinx.html.*
import kotlinx.html.stream.createHTML


import org.example.dataClasses.Contact
import org.example.dataClasses.Organization
import org.example.htmx.pages.allOrganizationsPage
import org.example.htmx.pages.updateOrganizationPage

import org.jetbrains.exposed.v1.jdbc.selectAll
import org.jetbrains.exposed.v1.jdbc.transactions.transaction

import org.example.model.ContactTable
import org.example.model.OrganizationTable
import org.jetbrains.exposed.v1.core.eq
import java.time.format.DateTimeFormatter

@OptIn(ExperimentalKtorApi::class)
fun main() {
    // Init the database so the model objects can be used
    Handler(false)
    val baseurl = "http://localhost:8081"

    embeddedServer(Netty, 8081) {

        install(StatusPages) {
            exception<Throwable> { call, cause ->
                call.application.environment.log.error("Request failed", cause)
                call.respondText("Something went wrong\n$cause")
            }
        }


        routing {
            staticResources("/static", "static")

            get("/all") {
                val contacts = mutableListOf<Map<String, String?>>()
                val organizations = mutableListOf<Map<String, String?>>()
                val formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")

                transaction {
                    ContactTable.selectAll().forEach {
                        contacts.add(
                            mapOf(
                                "id" to it[ContactTable.id].toString(),
                                "organizationID" to it[ContactTable.organizationID].toString(),
                                "name" to it[ContactTable.name],
                                "pronouns" to it[ContactTable.pronouns],
                                "position" to it[ContactTable.position],
                                "directEmail" to it[ContactTable.directEmail],
                                "directPhone" to it[ContactTable.directPhone]
                            )
                        )
                    }
                    OrganizationTable.selectAll().forEach {
                        val lastUpdate = it[OrganizationTable.lastUpdate]
                        val formattedLastUpdate = lastUpdate.format(formatter) ?: "N/A"  // Format the lastUpdate or default to "N/A"


                        organizations.add(
                            mapOf(
                                "id" to it[OrganizationTable.id].toString(),
                                "name" to it[OrganizationTable.name],
                                "email" to it[OrganizationTable.email],
                                "streetAddress" to it[OrganizationTable.streetAddress],
                                "description" to it[OrganizationTable.description],
                                "city" to it[OrganizationTable.city],
                                "phoneNumber" to it[OrganizationTable.phoneNumber],
                                "province" to it[OrganizationTable.province],
                                "socialMedia" to it[OrganizationTable.socialMedia],
                                "website" to it[OrganizationTable.website],
                                "queerOwned" to it[OrganizationTable.queerOwned].toString(),
                                "queerInclusive" to it[OrganizationTable.queerInclusive].toString(),
                                "accessibilityID" to it[OrganizationTable.accessibilityInformation].toString(),
                                "categoryID" to it[OrganizationTable.categoryInformation].toString(),
                                "lastUpdate" to formattedLastUpdate
                            )
                        )
                    }
                }
                call.respondHtml { allOrganizationsPage(organizations,
                    call.request.path()) }
            }

            get("/update/{orgID}") {
                try {
                    val queryID = call.parameters["orgID"]?.toInt() ?: -1
                    val contactInfo: MutableList<Contact> = mutableListOf()
                    var organizationInfo: Organization? = null

                    transaction {
                        organizationInfo = OrganizationTable
                            .selectAll()
                            .map { Organization.fromRow(it) }
                            .firstOrNull()

                        ContactTable.selectAll()
                            .where { ContactTable.organizationID eq queryID }
                            .forEach { contact ->
                                try {
                                    val contactFromRow = Contact.fromRow(contact)
                                    contactInfo.add(contactFromRow)
                                } catch (e: Exception) {
                                    println("Error in Contact.fromRow: ${e.message}")
                                }
                            }
                    }

                    if (organizationInfo != null) {
                        call.respondHtml {
                            updateOrganizationPage(
                                organizationInfo as Organization,
                                contactInfo,
                                call.request.path()
                            )
                        }
                    } else {
                        call.respondText { "Couldn't get organization info" }
                    }
                } catch (e: Exception) {
                    println("Error: ${e.message}")
                    call.respondText { "An error occurred: ${e.message}" }
                }
            }
            hx.get("/update/get-new-contact-form"){
                call.respondText { """
                        <fieldset class="update-form-contact">
                            <legend>New Contact</legend>
                            <label for="newName">Name:</label>
                            <input type="text" name="newName" id="newName">
                            <br/>
                            <label for="newPronouns">Pronouns:</label>
                            <input type="text" name="newPronouns" id="newPronouns">
                            <br/>
                            <label for="newPosition">Position:</label>
                            <input type="text" name="newPosition" id="newPosition">
                            <br/>
                            <label for="newEmail">Direct Email:</label>
                            <input type="text" name="newEmail" id="newEmail">
                            <br/>
                            <label for="newPhone">Direct Phone:</label>
                            <input type="text" name="newPhone" id="newPhone">                            
                        </fieldset>
                    """.trimIndent()
                }
            }
        }
    }.start(wait = true)
}